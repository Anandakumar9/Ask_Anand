name: Code Quality Checks

on:
  pull_request:
    branches: [master, main, develop]
  push:
    branches: [master, main]

jobs:
  backend-quality:
    name: Backend Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./studypulse/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black mypy pylint bandit safety
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Black (Format Check)
        run: black --check app/
        continue-on-error: true

      - name: Run Flake8 (Linting)
        run: flake8 app/ --max-line-length=120 --extend-ignore=E203,W503
        continue-on-error: true

      - name: Run Pylint
        run: pylint app/ --disable=C0111,C0103,R0903 --max-line-length=120
        continue-on-error: true

      - name: Run Bandit (Security Scan)
        run: bandit -r app/ -f json -o bandit-report.json
        continue-on-error: true

      - name: Run Safety (Dependency Security)
        run: safety check --json
        continue-on-error: true

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: studypulse/backend/bandit-report.json

  backend-tests:
    name: Backend Tests & Coverage
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./studypulse/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Unit Tests
        run: pytest tests/unit -v --tb=short
        continue-on-error: false

      - name: Run Integration Tests
        run: pytest tests/integration -v --tb=short
        continue-on-error: false

      - name: Run E2E Tests
        run: pytest tests/e2e -v --tb=short -m e2e
        continue-on-error: false

      - name: Run Tests with Coverage
        run: |
          pytest tests/unit tests/integration tests/e2e \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=html:htmlcov \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=30 \
            -v

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./studypulse/backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      - name: Upload Coverage HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-html
          path: studypulse/backend/htmlcov

      - name: Comment Coverage on PR
        uses: py-cov-action/python-coverage-comment-action@v3
        if: github.event_name == 'pull_request'
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 70
          COVERAGE_PATH: studypulse/backend
        continue-on-error: true

  frontend-quality:
    name: Frontend Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./studypulse/frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: studypulse/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Run Type Check
        run: npm run type-check || npx tsc --noEmit
        continue-on-error: true

      - name: Build Check
        run: npm run build
        continue-on-error: true

  mobile-quality:
    name: Mobile Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./studypulse/mobile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Run Flutter Analyze
        run: flutter analyze
        continue-on-error: true

      - name: Run Flutter Format Check
        run: flutter format --set-exit-if-changed .
        continue-on-error: true

      - name: Run Flutter Test
        run: flutter test
        continue-on-error: true
