name: Shannon Security Testing

on:
  pull_request:
    branches: [master, main]
    paths:
      - 'studypulse/backend/**'
  schedule:
    # Run monthly on the 1st at midnight
    - cron: '0 0 1 * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  security-scan:
    name: Shannon Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install backend dependencies
        working-directory: ./studypulse/backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start Backend Server
        working-directory: ./studypulse/backend
        run: |
          # Start backend in background
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          # Wait for server to start
          sleep 10
          # Verify server is running
          curl -f http://localhost:8000/health || exit 1

      - name: Pull Shannon Docker Image
        run: |
          # For now, assume Shannon image needs to be built
          # In production, this would pull from a registry
          echo "Building Shannon image..."
          # docker pull keygraph/shannon:latest

      - name: Run Shannon Security Tests
        run: |
          docker run --rm \
            --network host \
            -e ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }} \
            -v ${{ github.workspace }}:/workspace \
            shannon \
            --url http://localhost:8000 \
            --output /workspace/shannon-security-report.md
        continue-on-error: true

      - name: Parse Security Report
        id: parse-report
        if: always()
        run: |
          if [ -f shannon-security-report.md ]; then
            # Extract critical/high count (customize based on actual Shannon output)
            critical=$(grep -i "critical" shannon-security-report.md | wc -l)
            high=$(grep -i "high" shannon-security-report.md | wc -l)

            echo "critical=$critical" >> $GITHUB_OUTPUT
            echo "high=$high" >> $GITHUB_OUTPUT

            # Extract summary
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            head -n 20 shannon-security-report.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "summary=No report generated" >> $GITHUB_OUTPUT
          fi

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: shannon-security-report
          path: shannon-security-report.md
          retention-days: 90

      - name: Comment on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const critical = '${{ steps.parse-report.outputs.critical }}';
            const high = '${{ steps.parse-report.outputs.high }}';

            let reportContent = 'Shannon security scan completed.';
            if (fs.existsSync('shannon-security-report.md')) {
              reportContent = fs.readFileSync('shannon-security-report.md', 'utf8')
                .split('\n')
                .slice(0, 30)
                .join('\n');
            }

            const comment = `## ðŸ”’ Shannon Security Scan Results

            - **Critical Issues:** ${critical}
            - **High Issues:** ${high}

            <details>
            <summary>Security Report Preview</summary>

            \`\`\`markdown
            ${reportContent}
            \`\`\`

            </details>

            ðŸ“¥ Download full report from the Actions artifacts.

            ${parseInt(critical) > 0 ? 'âš ï¸ **CRITICAL issues found! Address before merging.**' : ''}
            ${parseInt(high) > 0 ? 'âš ï¸ **HIGH severity issues found! Review before merging.**' : ''}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail on Critical Issues
        if: ${{ success() && fromJSON(steps.parse-report.outputs.critical) > 0 }}
        run: |
          echo "::error::Critical security issues found! Check the security report."
          exit 1

  create-security-issues:
    name: Create GitHub Issues for Findings
    needs: security-scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'  # Only on scheduled runs

    steps:
      - name: Download Security Report
        uses: actions/download-artifact@v4
        with:
          name: shannon-security-report

      - name: Create Issues for High+ Findings
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('shannon-security-report.md', 'utf8');

            // Parse report and create issues (customize based on Shannon output format)
            // This is a template - adjust based on actual Shannon report structure

            const findings = report.split('###').slice(1);  // Split by finding headers

            for (const finding of findings) {
              if (finding.match(/\[(CRITICAL|HIGH)\]/i)) {
                const title = finding.split('\n')[0].trim();
                const body = `## Security Finding from Shannon

                ${finding}

                ---
                **Source:** Monthly Shannon Security Audit
                **Date:** ${new Date().toISOString().split('T')[0]}
                **Labels:** security, automated
                `;

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[Security] ${title}`,
                  body: body,
                  labels: ['security', 'shannon', 'automated']
                });
              }
            }
